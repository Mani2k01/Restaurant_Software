<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parcel Order</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --red: #c62828;
            --green: #22c55e;
            --orange: #f59e0b;
            --bg: #f3f4f6;
            --card: #ffffff;
            --dark: #0f172a;
            --shadow: 0 8px 20px rgba(0, 0, 0, .08);
            --cart-bar-height: 64px;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg);
        }

        /* HEADER */
        .header {
            background: var(--red);
            color: #fff;
            padding: 14px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .search {
            padding: 8px 12px;
            border-radius: 20px;
            border: none;
            width: 180px;
        }

        /* LAYOUT */
        .layout {
            display: grid;
            grid-template-columns: 220px 1fr;
            height: calc(100vh - 110px);
        }

        /* SIDEBAR */
        .sidebar {
            background: #fff;
            padding: 14px;
        }

        .cat {
            padding: 10px 14px;
            border-radius: 14px;
            margin-bottom: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .cat.active {
            background: #fde2e2;
            color: var(--red);
        }

        /* MENU */
        .menu {
            padding: 16px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
            padding-bottom: 90px;
        }

        /* FOOD CARD */
        .food {
            background: var(--card);
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform .2s ease, box-shadow .2s ease;
        }

        .food:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,.12);
        }

        .food img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .food-body {
            padding: 10px;
        }

        .food-name {
            font-size: 14px;
            font-weight: 600;
        }

        .food-price {
            color: #b91c1c;
            font-weight: 600;
            margin: 4px 0;
        }

        .meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .veg {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #22c55e;
        }

        .nonveg {
            background: #ef4444;
        }

        /* QTY */
        .qty {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .qty button {
            width: 30px;
            height: 30px;
            border: none;
            background: #e5e7eb;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
        }

        /* CART BAR */
        .cart-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--cart-bar-height);
            background: #0f172a;
            color: #fff;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 3000;
        }

        .cart-bar button {
            background: var(--green);
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        /* DRAWER */
        .drawer {
            position: fixed;
            top: 0;
            right: -420px;
            width: 420px;
            height: calc(100vh - var(--cart-bar-height));
            bottom: var(--cart-bar-height);
            background: #fff;
            box-shadow: -8px 0 30px rgba(0,0,0,.25);
            transition: right .3s ease;
            display: flex;
            flex-direction: column;
            z-index: 2000;
        }

        .drawer.open { right: 0; }

        .drawer-header {
            background: #0f172a;
            color: #fff;
            padding: 14px;
            display: flex;
            justify-content: space-between;
            font-weight: 600;
        }

        .drawer-body {
            flex: 1;
            padding: 16px;
            overflow-y: auto;          
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
        }

        .drawer-total {
            padding: 12px 16px;
            border-top: 1px solid #e5e7eb;
            font-weight: 600;
        }

        .drawer-footer {
            padding: 16px;
            display: grid;
            gap: 10px;
        }

        .drawer-footer button {
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        .confirm { background: var(--green); color: #fff; }
        .pay { background: var(--orange); color: #000; }

        .footer {
            text-align: center;
            padding: 22px;
            font-size: 13px;
            color: var(--muted);
        }
        

        .ordered { color: var(--muted); }
        .preparing { color: var(--orange); }
        .distribution { color: var(--green); }
        .cancelled { color: #b91c1c; }

    </style>
</head>

<body>

<div class="header">
    ðŸ“¦ Parcel Order
    <input class="search" placeholder="Search food">
</div>

<form action="/parcel" method="post" onsubmit="return validateOrder()">

<div class="layout">

    <div class="sidebar">
        <div class="cat active" data-filter="All">All</div>
        <div class="cat" data-filter="South Indian">South Indian</div>
        <div class="cat" data-filter="Starters">Starters</div>
        <div class="cat" data-filter="Main Course">Main Course</div>
        <div class="cat" data-filter="Beverages">Beverages</div>
        <div class="cat" data-filter="Combos">Combos</div>
        <div class="cat" data-filter="VegOnly">ðŸ¥¬ Veg Only</div>
    </div>

    <div class="menu">
        {% for food in foods %}
        <div class="food"
             data-name="{{ food.name }}"
             data-price="{{ food.price }}"
             data-veg="{{ 'veg' if food.veg else 'nonveg' }}"
             data-category="{{ food.category }}">

            <img src="{{ food.img }}" alt="{{ food.name }}">

            <div class="food-body">
                <div class="food-name">
                    {{ food.name }}
                    {% if food.popular %}
                    <i class="fa-solid fa-star" style="color:#facc15;"></i>
                    {% endif %}
                </div>

                <div class="meta">
                    <div class="food-price">â‚¹{{ food.price }}</div>
                    <div class="veg {% if not food.veg %}nonveg{% endif %}"></div>
                </div>

                <div class="qty">
                    <button type="button" onclick="chg(this,-1)">âˆ’</button>
                    <span>0</span>
                    <button type="button" onclick="chg(this,1)">+</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

</div>

<div class="cart-bar">
    <div>Total â‚¹0</div>
    <button type="button" onclick="openDrawer()">View Order</button>
</div>

        <div class="drawer" id="drawer">
            <div class="drawer-header">
                Current Order
                <button type="button" onclick="closeDrawer()">âœ•</button>
            </div>

            <div class="drawer-body">

                <!-- Order Name -->
                <div style="margin-bottom:12px;">
                    <label style="font-weight:600; font-size:13px;">Order Name / Customer</label>
                    <input 
                        id="orderName"
                        type="text"
                        placeholder="Eg: Table {{parcel.table}} - Ramesh"
                        style="
                            width:100%;
                            padding:10px;
                            margin-top:6px;
                            border-radius:10px;
                            border:1px solid #e5e7eb;
                            font-size:14px;
                        "
                        name="order_name"
                        value="{{ parcel.customer if parcel else '' }}"
                    >
                    <input type="hidden" name="order_data" id="orderData">
                    <input type="hidden" name="table_no" value="{{ parcel.table }}">
                </div>

                <!-- Order Mode -->
                <div style="margin-bottom:14px;">
                    <label style="font-weight:600; font-size:13px;">Order Mode</label>

                    <div style="display:flex; gap:12px; margin-top:8px;">
                        <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                            <input type="radio" name="order_mode" value="TAKEAWAY" checked onchange="toggleAddress(false)">
                            Takeaway
                        </label>

                        <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                            <input type="radio" name="order_mode" value="ONLINE" onchange="toggleAddress(true)">
                            Online
                        </label>
                    </div>
                </div>

                <!-- Address (Hidden by default) -->
                <div id="addressBox" style="display:none; margin-bottom:12px;">
                    <label style="font-weight:600; font-size:13px;">Delivery Address</label>
                    <textarea
                        name="delivery_address"
                        rows="3"
                        placeholder="Enter full delivery address"
                        style="
                            width:100%;
                            padding:10px;
                            margin-top:6px;
                            border-radius:10px;
                            border:1px solid #e5e7eb;
                            font-size:14px;
                            resize:none;
                        "
                    ></textarea>
                </div>


                <!-- Order Items -->
                <div id="orderItems">
                    Selected items will appear here
                </div>

            </div>


            <div class="drawer-total">
                <span>Total</span>
                <strong>â‚¹<span id="drawerTotal">0</span></strong>
            </div>

            <div class="drawer-footer">
                <button class="confirm" type="submit" name="action" value="submit">Confirm Order</button>
                <!-- <button class="confirm" type="submit" name="action" value="edit">Add More Dishes</button> -->
                <button class="pay" type="submit" name="action" value="pay">Pay Bill</button>
            </div>
        </div>
</form>


 <script>
        const order = JSON.parse('{{ session.get("active_order", {}) | tojson | safe }}');
        let orderName = "";

        function chg(btn, delta) {
            const card = btn.closest(".food");
            const name = card.dataset.name;
            const price = parseInt(card.dataset.price);
            const qtySpan = btn.parentElement.querySelector("span");

            let qty = parseInt(qtySpan.innerText);
            qty = Math.max(0, qty + delta);
            qtySpan.innerText = qty;

            if (qty === 0) {
                delete order[name];
            } else {
                order[name] = {
                    qty: qty,
                    price: price,
                    total: qty * price
                };
            }

            updateCart();
        }

        function updateCart() {
            let total = 0;
            let html = "";

            for (let item in order) {
                total += order[item].total;
                html += `<div>${item} Ã— ${order[item].qty} = â‚¹${order[item].total}</div>`;
            }

            document.querySelector(".cart-bar div").innerText = `Total â‚¹${total}`;
            document.getElementById("orderItems").innerHTML = html || "No items selected";
            document.getElementById("drawerTotal").innerText = total;

            // ðŸ”¥ SEND TO FLASK
            document.getElementById("orderData").value = JSON.stringify(order);
        }

        function openDrawer() {
            document.getElementById("drawer").classList.add("open");
        }

        function closeDrawer() {
            document.getElementById("drawer").classList.remove("open");
        }
        
        // for filter wise category
        const cats = document.querySelectorAll(".cat");
        const foods = document.querySelectorAll(".food");

        cats.forEach(cat => {
            cat.addEventListener("click", () => {

                // Active highlight
                cats.forEach(c => c.classList.remove("active"));
                cat.classList.add("active");

                const filter = cat.dataset.filter;

                foods.forEach(food => {
                    const foodCategory = food.dataset.category;
                    const isVeg = food.dataset.veg === "veg";

                    // Show all
                    if (filter === "All") {
                        food.style.display = "flex";
                    }
                    // Veg only
                    else if (filter === "VegOnly") {
                        food.style.display = isVeg ? "flex" : "none";
                    }
                    // Normal category
                    else {
                        food.style.display = (foodCategory === filter) ? "flex" : "none";
                    }
                });
            });
        });

        // for order body with name 
        document.addEventListener("input", function (e) {
            if (e.target.id === "orderName") {
                orderName = e.target.value.trim();
            }
        });

        function toggleAddress(show) {
            const box = document.getElementById("addressBox");
            box.style.display = show ? "block" : "none";
        }

        // on order submit
        function validateOrder() {
            if (Object.keys(order).length === 0) {
                alert("Please select at least one item");
                return false;
            }

            const name = document.getElementById("orderName").value.trim();
            if (!name) {
                alert("Please enter Order Name / Customer");
                document.getElementById("orderName").focus();
                return false;
            }

            const mode = document.querySelector('input[name="order_mode"]:checked').value;

            if (mode === "ONLINE") {
                const address = document.querySelector('textarea[name="delivery_address"]').value.trim();
                if (!address) {
                    alert("Please enter delivery address");
                    document.querySelector('textarea[name="delivery_address"]').focus();
                    return false;
                }
            }

            return true;
        }


        window.onload = updateCart;


        window.onload = () => {
            updateCart();

            document.querySelectorAll(".food").forEach(card => {
                const name = card.dataset.name;
                if (order[name]) {
                    card.querySelector(".qty span").innerText = order[name].qty;
                }
            });
        };


    </script>


</body>
</html>
