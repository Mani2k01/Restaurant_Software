    <!DOCTYPE html>
    <html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Table Order</title>

        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

        <style>
            :root {
                --red: #c62828;
                --green: #22c55e;
                --orange: #f59e0b;
                --bg: #f3f4f6;
                --card: #ffffff;
                --dark: #0f172a;
                --muted: #6b7280;
                --shadow: 0 8px 20px rgba(0, 0, 0, .08);
                --cart-bar-height: 64px;
            }
            
            * {
                box-sizing: border-box;
            }
            
            body {
                margin: 0;
                font-family: 'Inter', sans-serif;
                background: var(--bg);
            }
            /* HEADER */
            
            .header {
                background: var(--red);
                color: #fff;
                padding: 14px 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-weight: 600;
            }
            
            .search {
                padding: 8px 12px;
                border-radius: 20px;
                border: none;
                width: 180px;
            }
            /* LAYOUT */
            
            .layout {
                display: grid;
                grid-template-columns: 220px 1fr;
                height: calc(100vh - 110px);
            }
            /* SIDEBAR */
            
            .sidebar {
                background: #fff;
                padding: 14px;
            }
            
            .cat {
                padding: 10px 14px;
                border-radius: 14px;
                margin-bottom: 8px;
                cursor: pointer;
                font-weight: 600;
            }
            
            .cat.active {
                background: #fde2e2;
                color: var(--red);
            }
            
            .menu {
                padding: 16px;
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 16px;
                align-items: start;
                padding-bottom: 90px;
            }
            /* FOOD CARD */
            
            .food {
                background: var(--card);
                border-radius: 16px;
                box-shadow: var(--shadow);
                height: auto;
                max-height: 260px;
                /* padding: 12px; */
            }
            
            .food-img {
                height: 120px;
                background: #e5e7eb;
                /* border-radius: 12px; */
                margin-bottom: 8px;
            }
            
            .food-name {
                font-weight: 600;
                font-size: 14px;
            }
            
            .food-price {
                color: #b91c1c;
                font-weight: 600;
                margin: 4px 0;
            }
            
            .meta {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .star {
                color: #facc15;
            }
            
            .veg {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: #22c55e;
            }
            
            .nonveg {
                background: #ef4444;
            }
            /* QTY */
            
            .qty {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 6px;
            }
            
            .qty button {
                width: 28px;
                height: 28px;
                border: none;
                border-radius: 8px;
                background: #e5e7eb;
                font-size: 18px;
                cursor: pointer;
            }
            /* BOTTOM BAR */
            
            .cart-bar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: var(--cart-bar-height);
                background: #0f172a;
                color: #fff;
                padding: 12px 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                z-index: 3000;
            }
            
            .cart-bar button {
                background: var(--green);
                border: none;
                padding: 10px 16px;
                border-radius: 10px;
                font-weight: 600;
                cursor: pointer;
            }
            /* DRAWER */
            
            .drawer {
                position: fixed;
                top: 0;
                right: -420px;
                width: 420px;
                height: calc(100vh - var(--cart-bar-height));
                bottom: var(--cart-bar-height);
                background: #fff;
                box-shadow: -8px 0 30px rgba(0, 0, 0, .25);
                transition: right .3s ease;
                display: flex;
                flex-direction: column;
                z-index: 2000;
            }

            
            .drawer.open {
                right: 0;
            }
            
            .drawer-header {
                background: #0f172a;
                color: #fff;
                padding: 14px;
                display: flex;
                justify-content: space-between;
                font-weight: 600;
            }
            
            .drawer-body {
                flex: 1;                 
                padding: 16px;
                overflow-y: auto;        
                overscroll-behavior: contain;
            }

            .drawer-body::-webkit-scrollbar {
                width: 6px;
            }

            .drawer-body::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 6px;
            }
            
            .drawer-total {
                padding: 12px 16px;
                border-top: 1px solid #e5e7eb;
                font-weight: 600;
            }
            
            .drawer-footer {
                padding: 16px;
                display: grid;
                gap: 10px;
            }
            
            .drawer-footer button {
                padding: 12px;
                border: none;
                border-radius: 10px;
                font-weight: 600;
                cursor: pointer;
            }
            
            .confirm {
                background: var(--green);
                color: #fff;
            }
            
            .pay {
                background: #f59e0b;
                color: #000;
            }
            
            .food {
                background: var(--card);
                border-radius: 14px;
                box-shadow: 0 6px 14px rgba(0, 0, 0, .08);
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            
            .food img {
                width: 100%;
                height: 120px;
                object-fit: cover;
                aspect-ratio: 4 / 3;
                min-height: 120px;
                max-height: 120px
            }
            
            .food-body {
                padding: 10px;
            }
            
            .food-name {
                font-size: 14px;
                font-weight: 600;
            }
            
            .order-drawer {
                z-index: 2000;
            }
            
            .table-status-bar {
                z-index: 100;
            }
            
            .food-meta {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 8px;
                white-space: nowrap;
            }
            
            .dot {
                flex-shrink: 0;
                margin-left: auto;
            }
            
            .price {
                font-weight: 600;
                color: #991b1b;
            }
            
            .dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
            }
            
            .dot.veg {
                background: var(--veg);
            }
            
            .dot.nonveg {
                background: var(--nonveg);
            }
            /* QTY */
            
            .qty {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 8px;
            }
            
            .qty button {
                width: 30px;
                height: 30px;
                border: none;
                background: #e5e7eb;
                border-radius: 8px;
                font-size: 18px;
                cursor: pointer;
            }
            
            .btn.clean {
                background: #3b82f6;
                color: white;
            }
            
            .btn.available {
                background: #22c55e;
            }
            
            .table-status-bar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 16px;
                background: #ffffff;
                border-bottom: 1px solid #e5e7eb;
                position: sticky;
                top: 0;
                z-index: 20;
            }
            
            .table-info {
                display: flex;
                gap: 10px;
                align-items: center;
                font-weight: 600;
            }
            
            .table-state {
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 12px;
            }
            
            .table-state.occupied {
                background: #fee2e2;
                color: #991b1b;
            }
            
            .table-state.cleaning {
                background: #dbeafe;
                color: #1e40af;
            }
            
            .table-state.available {
                background: #dcfce7;
                color: #166534;
            }
            
            .table-actions {
                display: flex;
                gap: 8px;
            }
            
            .table-actions .btn {
                padding: 8px 12px;
                border: none;
                border-radius: 10px;
                font-size: 13px;
                font-weight: 600;
                cursor: pointer;
            }
            
            .btn.clean {
                background: #3b82f6;
                color: white;
            }
            
            .btn.available {
                background: #22c55e;
                color: black;
            }
            
            .food {
                transition: transform .2s ease, box-shadow .2s ease;
            }
            
            .food:hover {
                transform: translateY(-4px);
                box-shadow: 0 12px 24px rgba(0, 0, 0, .12);
            }
            
            .qty button {
                transition: background .15s ease;
            }
            
            .qty button:hover {
                background: #d1d5db;
            }
            
            .food {
                transition: transform .2s ease, box-shadow .2s ease;
            }
            
            .food:hover {
                transform: translateY(-4px);
                box-shadow: 0 12px 24px rgba(0, 0, 0, .12);
            }
            
            .qty button {
                transition: background .15s ease;
            }
            
            .qty button:hover {
                background: #d1d5db;
            }
        </style>
    </head>

    <body>

        <div class="header">
            ðŸ§¾ Table-order
            <input class="search" placeholder="Search food">
        </div>
        <div class="table-status-bar">
            <div class="table-info">
                <span class="table-no">Table {{order.table}}</span>
                <span class="table-state occupied" id="tableStateText">{{order.status}}</span>
            </div>

            <div class="table-actions">
                <!-- <button class="btn clean" onclick="setCleaning()">ðŸ§¹ Table Cleaning</button> -->
                <button class="btn available" onclick="setAvailable()">âœ… Set Available</button>
            </div>
        </div>

        <form action="/order_entry" method="post" onsubmit="return validateOrder()">
            <div class="layout">

                <div class="sidebar">
                    <div class="cat active" data-filter="All">All</div>
                    <div class="cat" data-filter="South Indian">South Indian</div>
                    <div class="cat" data-filter="Starters">Starters</div>
                    <div class="cat" data-filter="Main Course">Main Course</div>
                    <div class="cat" data-filter="Beverages">Beverages</div>
                    <div class="cat" data-filter="Combos">Combos</div>
                    <div class="cat" data-filter="VegOnly">ðŸ¥¬ Veg Only</div>
                </div>

                <div class="menu">
                    {% for food in foods %}
                    <div class="food"
                        data-name="{{ food.name }}"
                        data-price="{{ food.price }}"
                        data-veg="{{ 'veg' if food.veg else 'nonveg' }}"
                        data-category="{{ food.category }}">

                        <img src="{{ food.img }}" alt="{{ food.name }}">

                        <div class="food-body">
                            <div class="food-name">
                                {{ food.name }}
                                {% if food.popular %}
                                <i class="fa-solid fa-star star"></i>
                                {% endif %}
                            </div>

                            <div class="meta">
                                <div class="food-price">â‚¹{{ food.price }}</div>
                                <div class="veg {% if not food.veg %}nonveg{% endif %}"></div>
                            </div>

                            <div class="qty">
                                <button type="button" onclick="chg(this,-1)">âˆ’</button>
                                <span>0</span>
                                <button type="button" onclick="chg(this,1)">+</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

            </div>
        

            <div class="cart-bar">
                <div>Total â‚¹0</div>
                <button type="button" onclick="openDrawer()">View Order</button>
            </div>

            <div class="drawer" id="drawer">
                <div class="drawer-header">
                    Current Order
                    <button type="button" onclick="closeDrawer()">âœ•</button>
                </div>

                <div class="drawer-body">

                    <!-- Order Name -->
                    <div style="margin-bottom:12px;">
                        <label style="font-weight:600; font-size:13px;">Order Name / Customer</label>
                        <input 
                            id="orderName"
                            type="text"
                            placeholder="Eg: Table {{order.table}} - Ramesh"
                            style="
                                width:100%;
                                padding:10px;
                                margin-top:6px;
                                border-radius:10px;
                                border:1px solid #e5e7eb;
                                font-size:14px;
                            "
                            name="order_name"
                            value="{{order_person | default('')}}"
                        >
                        <input type="hidden" name="order_data" id="orderData">
                        <input type="hidden" name="table_no" value="{{ order.table }}">
                    </div>

                    <!-- Order Items -->
                    <div id="orderItems">
                        Selected items will appear here
                    </div>

                </div>


                <div class="drawer-total">
                    <span>Total</span>
                    <strong>â‚¹<span id="drawerTotal">0</span></strong>
                </div>

                <div class="drawer-footer">
                    <button class="confirm" type="submit" name="action" value="submit">Confirm Order</button>
                    <!-- <button class="confirm" type="submit" name="action" value="edit">Add More Dishes</button> -->
                    <button class="pay" type="submit" name="action" value="pay">Pay Bill</button>
                </div>
            </div>
        </form>

        <script id="active-order" type="application/json">
            {{ active_order | tojson | safe }}
        </script>

        <script id="order-config" type="application/json">
            {
                "isConfirmed": {{ order_id is not none | tojson }},
                "orderId": {{ order_id | tojson }}
            }
        </script>

        <script id="currenttable" type="application/json">
            {{ order.table | tojson | safe }}
        </script>

        <script>
            const order = JSON.parse(document.getElementById("active-order").textContent);
            let orderName = "";

            const config = JSON.parse(
                document.getElementById("order-config").textContent
            );

            const isConfirmed = config.isConfirmed;
            const orderId = config.orderId;

            const currenttable = JSON.parse(document.getElementById("currenttable").textContent);
            console.log("Current Table ID:", currenttable);

            function chg(btn, delta) {
                const card = btn.closest(".food");
                const name = card.dataset.name;
                const price = parseInt(card.dataset.price);
                const qtySpan = btn.parentElement.querySelector("span");

                let qty = parseInt(qtySpan.innerText);
                qty = Math.max(0, qty + delta);
                qtySpan.innerText = qty;

                if (qty === 0) {
                    delete order[name];
                } else {
                    order[name] = {
                        qty: qty,
                        price: price,
                        total: qty * price
                    };
                }

                updateCart();
            }

            function updateCart() {
                let total = 0;
                let html = "";

                for (let item in order) {
                    if (order[item].status && order[item].status === "CANCELLED") continue;
                    total += order[item].total;

                    html += `
                        <div style="
                            display:flex;
                            justify-content:space-between;
                            align-items:center;
                            padding:8px 0;
                            border-bottom:1px dashed #e5e7eb;
                        ">
                            <div>
                                <strong>${item}</strong><br>
                                <small>â‚¹${order[item].price} Ã— ${order[item].qty}</small>
                            </div>

                            <div style="display:flex; align-items:center; gap:10px;">
                                <strong>â‚¹${order[item].total}</strong>
                                <button 
                                    type="button"
                                    onclick="${
                                        isConfirmed
                                            ? `cancelConfirmedItem('${item}', ${orderId})`
                                            : `cancelItem('${item}')`
                                    }"
                                    style="
                                        background:#fee2e2;
                                        border:none;
                                        color:#991b1b;
                                        border-radius:8px;
                                        padding:6px 8px;
                                        cursor:pointer;
                                    "
                                    title="Cancel item"
                                >
                                    âœ•
                                </button>
                            </div>
                        </div>
                    `;
                }

                document.querySelector(".cart-bar div").innerText = `Total â‚¹${total}`;
                document.getElementById("orderItems").innerHTML = html || "No items selected";
                document.getElementById("drawerTotal").innerText = total;

                // send to flask
                document.getElementById("orderData").value = JSON.stringify(order);
            }
            function openDrawer() {
                document.getElementById("drawer").classList.add("open");
            }

            function closeDrawer() {
                document.getElementById("drawer").classList.remove("open");
            }
            
            // for filter wise category
            const cats = document.querySelectorAll(".cat");
            const foods = document.querySelectorAll(".food");

            cats.forEach(cat => {
                cat.addEventListener("click", () => {

                    // Active highlight
                    cats.forEach(c => c.classList.remove("active"));
                    cat.classList.add("active");

                    const filter = cat.dataset.filter;

                    foods.forEach(food => {
                        const foodCategory = food.dataset.category;
                        const isVeg = food.dataset.veg === "veg";

                        // Show all
                        if (filter === "All") {
                            food.style.display = "flex";
                        }
                        // Veg only
                        else if (filter === "VegOnly") {
                            food.style.display = isVeg ? "flex" : "none";
                        }
                        // Normal category
                        else {
                            food.style.display = (foodCategory === filter) ? "flex" : "none";
                        }
                    });
                });
            });

            // for order body with name 
            document.addEventListener("input", function (e) {
                if (e.target.id === "orderName") {
                    orderName = e.target.value.trim();
                }
            });

            // on order submit
            function validateOrder() {
                if (Object.keys(order).length === 0) {
                    alert("Please select at least one item");
                    return false;
                }

                const name = document.getElementById("orderName").value.trim();
                if (!name) {
                    alert("Please enter Order Name / Customer");
                    document.getElementById("orderName").focus();
                    return false;
                }

                return true;
            }

            window.onload = updateCart;

            function cancelItem(itemName) {
                delete order[itemName];

                // reset qty in food card
                document.querySelectorAll(".food").forEach(food => {
                    if (food.dataset.name === itemName) {
                        food.querySelector(".qty span").innerText = "0";
                    }
                });

                updateCart();
            }

            function cancelConfirmedItem(itemName, orderId) {
                if (!confirm(`Cancel ${itemName}?`)) return;

                fetch("/order/cancel-item", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        order_id: orderId,
                        item_name: itemName,
                        table_id: currenttable 
                    })
                })
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        alert("Item cancelled");
                        location.reload();   // ðŸ”¥ important
                    } else {
                        alert(res.msg);
                    }
                });
            }



            function setAvailable() {
                const tableId = currenttable;  // comes from {{ order.table }}

                fetch("/table/set-available", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ table_id: tableId })
                })
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        alert("Table marked as available âœ…");
                        // Update UI
                        const stateText = document.getElementById("tableStateText");
                        stateText.innerText = res.new_status;
                        stateText.classList.remove("occupied", "cleaning");
                        stateText.classList.add("available");
                    } else {
                        alert(res.msg || "Failed to update table");
                    }
                });
            }

        </script>

    </body>

    </html>